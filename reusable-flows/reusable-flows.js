"use strict";module.exports=function(e){e.nodes.registerType("reusable-in",(function(t){e.nodes.createNode(this,t);var n=this;n.on("input",(function(e,t,o){(t=t||function(){n.send.apply(n,arguments)})(e),o&&o()}));var o="reusable:"+t.id;function r(e){n.receive(e)}e.events.on(o,r),n.on("close",(function(){e.events.removeListener(o,r)}))})),e.nodes.registerType("reusable-out",(function(t){e.nodes.createNode(this,t),this.on("input",(function(t,n,o){try{var r=t._reusableFlows,s=r.Stack.pop();if(null==s)throw"reusable-out: no reusable to return to found";r.Mode="return",e.events.emit("reusable:"+s,t),o&&o()}catch(e){throw'reusable-out: broken "msg" (broken or missing internals)'}}))})),e.nodes.registerType("reusable",(function(t){var n;e.nodes.createNode(this,t);var o=this;o.on("input",(function(r,s,a){if(s=s||function(){o.send.apply(o,arguments)},null==n)throw"reusable: no flow found that could be called";var i=r._reusableFlows;switch(null==i&&(i=r._reusableFlows={Stack:[]}),i.Mode){case void 0:i.Stack.push(t.id),e.events.emit("reusable:"+n.id,r);break;case"return":delete i.Mode,s(r),a&&a();break;default:throw'reusable: broken "msg" (missing "Mode")'}}));var r="reusable:"+t.id;function s(e){o.receive(e)}e.events.on(r,s);var a="reusable:"+t.id+"-FlowToCall";function i(e){null==(n=e)?o.status({fill:"red",shape:"dot",text:"no flow to call"}):o.status({})}e.events.on(a,i),o.on("close",(function(){e.events.removeListener(r,s),e.events.removeListener(a,i)}))})),e.events.on("flows:started",(function(){var t=Object.create(null),n=Object.create(null),o=Object.create(null),r=Object.create(null);function s(e){if("tab"!==e.type){var o=n[e.z];return null==o?t[e.z]:o}}function a(e){if("tab"===e.type)return e;var o=t[e.z];return null==o&&(o=n[e.z]),null==o?void 0:a(o)}function i(t,n){e.events.emit("reusable:"+t+"-FlowToCall",n)}e.nodes.eachNode((function(e){switch(e.type){case"tab":t[e.id]=e;break;case"subflow":n[e.id]=e;break;case"reusable-in":o[e.id]=e;break;case"reusable":r[e.id]=e}}));e:for(var l in r){var u=r[l],c=(u.target||"").toLowerCase().split(":"),b=c[0],d=c[1];for(var f in null==d?(d=b.trim(),b=""):(b=b.trim(),d=d.trim()),o){var v=o[f];if((v.name||"").toLowerCase()===d)if(""===b){if(u.z===v.z){i(l,v);continue e}}else{if(b!==((a(v)||{}).label||"").toLowerCase())continue;if(u.z===v.z||u.z!==v.z&&"global"===v.scope&&"subflow"!==(s(v)||{}).type){i(l,v);continue e}}}i(l,void 0)}}))};
//# sourceMappingURL=reusable-flows.js.map
